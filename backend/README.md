# Termsplain Backend API

Node.js + Express + TypeScript API for lease analysis.

## Install

```bash
cd backend
npm install
```

## Run Development Server

```bash
npm run dev
```

Server runs on `http://localhost:4000`

## Environment Variables

Create a `.env` file based on `.env.example` and set your Gemini key:

```bash
GEMINI_API_KEY=your_key_here
```

## Build for Production

```bash
npm run build
npm start
```

## API Endpoints

### GET /health

Health check endpoint.

**Response 200:**
```json
{
  "ok": true
}
```

### POST /analyze

Analyze full lease text and return red/yellow/green flags.

**Request Body:**
```json
{
  "text": "Your full lease text here..."
}
```

**Response 200:**
```json
{
  "summaryBullets": [
    "Early termination may result in fees if you leave before the lease term ends.",
    "Automatic renewal applies unless you provide advance written notice."
  ],
  "flags": [
    {
      "id": "flag-early-termination",
      "label": "Early termination penalty",
      "severity": "red",
      "evidenceSnippet": "Tenant agrees to pay a fee if the lease is terminated early without cause.",
      "whyItMatters": "Leaving before your lease ends could result in significant financial penalties."
    }
  ]
}
```

If `GEMINI_API_KEY` is missing, the API uses fallback summary bullets.

**Response 400:**
```json
{
  "error": "Lease text is required."
}
```

### POST /explain

Explain a single clause in plain English.

**Request Body:**
```json
{
  "clause": "The lease automatically renews unless written notice is provided 60 days prior..."
}
```

**Response 200:**
```json
{
  "explanation": "This clause outlines the conditions under which the lease may be renewed or terminated...",
  "keyPoints": [
    "Written notice is required to terminate or avoid renewal.",
    "Notice must be provided within the specified timeframe."
  ],
  "questionsToAsk": [
    "What is the exact notice period required in days?",
    "Does the notice need to be sent via certified mail or email?"
  ]
}
```

**Response 400:**
```json
{
  "error": "Clause text is required."
}
```

### POST /qa

Answer a question based on provided lease text.

**Request Body:**
```json
{
  "question": "Can I leave early?",
  "text": "Your full lease text here..."
}
```

**Response 200:**
```json
{
  "answer": "Based on the lease text you provided, early termination appears to be permitted but may involve a financial penalty...",
  "confidence": "medium",
  "basedOn": [
    "Early termination clause mentioning fees",
    "Notice requirements section"
  ]
}
```

**Response 400:**
```json
{
  "error": "Question is required."
}
```

or

```json
{
  "error": "Lease text is required."
}
```

## Example curl Commands

### Health Check
```bash
curl http://localhost:4000/health
```

### Analyze Lease
```bash
curl -X POST http://localhost:4000/analyze \
  -H "Content-Type: application/json" \
  -d '{"text": "This lease agreement is entered into on January 1, 2025. Tenant agrees to pay rent of $2000 per month. Early termination fee of two months rent applies if tenant leaves before month 10."}'
```

### Analyze Lease (Flag Detection Example)
```bash
curl -X POST http://localhost:4000/analyze \
  -H "Content-Type: application/json" \
  -d '{"text": "This lease automatically renews unless written notice 60 days before the end. An early termination fee applies if you terminate early."}'
```

### Explain Clause
```bash
curl -X POST http://localhost:4000/explain \
  -H "Content-Type: application/json" \
  -d '{"clause": "This lease automatically renews for another 12-month term unless Tenant provides written notice 60 days before the end date."}'
```

If `GEMINI_API_KEY` is missing, the API uses fallback explain responses.

### Ask Question
```bash
curl -X POST http://localhost:4000/qa \
  -H "Content-Type: application/json" \
  -d '{"question": "Can I leave early?", "text": "This lease agreement is entered into on January 1, 2025. Tenant agrees to pay rent of $2000 per month. Early termination fee of two months rent applies if tenant leaves before month 10."}'
```

If `GEMINI_API_KEY` is missing, the API uses fallback QA responses.

## Character Limits

- Lease text: 20,000 characters (soft limit, trimmed silently)
- Clause text: 8,000 characters (soft limit, trimmed silently)
- Question text: 500 characters (soft limit, trimmed silently)

All trimming is character-based (not word-based) and occurs after `.trim()` is applied.

## Notes

- Analyze summaries are generated by Gemini when `GEMINI_API_KEY` is set
- Explain and QA are generated by Gemini when `GEMINI_API_KEY` is set
- If Gemini is unavailable or the key is missing, fallback responses are returned
- Rate limit: 30 requests/minute per IP in dev
- Gemini responses are cached in-memory for 10 minutes and reset on server restart
- Designed to support Gemini integration later without refactoring
- CORS enabled for `http://localhost:3000`
- JSON body limit: 2MB
